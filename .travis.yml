language: node_js
node_js:
  - '12.14.1'
jobs:
  include:
    - stage: test
      script: yarn test
      after_success:
        - yarn codecov

    - stage: deploy
      script: semantic-release
      before_install:
        - openssl aes-256-cbc -K $encrypted_add538b067d0_key -iv $encrypted_add538b067d0_iv -in git_deploy_key.enc -out git_deploy_key -d
          # Make sure only the current user can read the private key
        - chmod 600 /tmp/git_deploy_key
        # Create a script to return the passphrase environment variable to ssh-add
        - echo 'echo ${SSH_PASSPHRASE}' > /tmp/askpass && chmod +x /tmp/askpass
        # Start the authentication agent
        - eval "$(ssh-agent -s)"
        # Add the key to the authentication agent
        - DISPLAY=":0.0" SSH_ASKPASS="/tmp/askpass" setsid ssh-add /tmp/git_deploy_key </dev/null

notifications:
  email:
    recipients:
      - me@silverxu.com
    on_success: always
    on_failure: always
